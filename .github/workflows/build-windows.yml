name: Build Windows Release

on:
  workflow_dispatch:
  push:
    branches: [main] # 根据你的主分支改
    tags: ["v*"]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 1. 【超级缓存1】缓存整个 winget 安装的程序（最重的一块！）
      - name: Cache winget packages
        id: cache-winget
        uses: actions/cache@v4
        with:
          path: |
            C:\Program Files\*
            C:\Program Files (x86)\*
            C:\Users\runneradmin\AppData\Local\Microsoft\WinGet\
          key: winget-2022-${{ hashFiles('.github/workflows/windows.yml') }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            winget-2022-

      # 2. 【超级缓存2】缓存 vcpkg 整个目录（包含已编译的 ffmpeg）
      - name: Cache vcpkg (including built ffmpeg)
        id: cache-vcpkg
        uses: actions/cache@v4
        with:
          path: C:\vcpkg
          key: vcpkg-ffmpeg-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            vcpkg-ffmpeg-

      # 3. 【超级缓存3】缓存 cargo（registry + git + target）
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\cargo\registry
            ~\AppData\Local\cargo\git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # 4. 【超级缓存4】缓存 Bun store（bun install 也会很快）
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Bun
          key: bun-${{ runner.os }}-${{ hashFiles('screenpipe-app-tauri/bun.lockb') }}
          restore-keys: bun-${{ runner.os }}-

      # 如果 winget 没缓存到，才去装（第一次或者你改了依赖时才会走这里）
      - name: Install tools via winget (only when cache miss)
        if: steps.cache-winget.outputs.cache-hit != 'true'
        run: |
          winget source reset --force
          winget install -e --id Microsoft.VisualStudio.2022.BuildTools --override "--wait --quiet --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended" --accept-package-agreements --accept-source-agreements
          winget install -e --id Rustlang.Rustup,LLVM.LLVM,Kitware.CMake,GnuWin32.UnZip,Git.Git,JernejSimoncic.Wget,7zip.7zip --accept-package-agreements --accept-source-agreements

      # 安装 Bun（如果没缓存到也会重新装，但很快）
      - name: Install Bun
        run: iwr https://bun.sh/install.ps1 -useb | iex

      # vcpkg：如果缓存没命中才重新 bootstrap 和编译 ffmpeg
      - name: Setup vcpkg (only when cache miss)
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          New-Item -ItemType Directory -Force -Path C:\vcpkg | Out-Null
          cd C:\vcpkg
          git clone https://github.com/microsoft/vcpkg.git .
          .\bootstrap-vcpkg.bat -disableMetrics
          .\vcpkg.exe integrate install
          .\vcpkg.exe install ffmpeg:x64-windows --triplet x64-windows

      # 环境变量（缓存命中后这些路径都还在，直接用就行）
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=C:\vcpkg\installed\x64-windows\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files (x86)\GnuWin32\bin" >> $env:GITHUB_PATH

      # 下面这些基本秒过，即使失败重跑也几乎不耗时
      - name: Install Intel OpenMP DLLs
        run: |
          python -m pip install --upgrade pip
          $mkl = Resolve-Path "screenpipe-app-tauri\src-tauri\mkl" -ErrorAction SilentlyContinue
          if (-not $mkl) { New-Item -ItemType Directory -Force -Path "screenpipe-app-tauri\src-tauri\mkl" }
          $temp = "tmp_openmp"
          New-Item -ItemType Directory -Force -Path $temp
          python -m pip install intel-openmp --target $temp --no-cache-dir
          Copy-Item "$temp\*.dll" "screenpipe-app-tauri\src-tauri\mkl\" -Force
          Remove-Item $temp -Recurse -Force

      - name: Copy vcruntime140.dll
        run: |
          $src = "C:\Windows\System32\vcruntime140.dll"
          $dst = "screenpipe-app-tauri\src-tauri\vcredist"
          New-Item -ItemType Directory -Force -Path $dst
          Copy-Item $src -Destination $dst -Force

      - name: Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cargo build --release
        run: cargo build --release --locked

      - name: Tauri build
        run: |
          cd screenpipe-app-tauri
          bun install --frozen-lockfile
          bun tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: screenpipe-windows
          path: |
            screenpipe-app-tauri/src-tauri/target/release/bundle/msi/*.msi
            screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe
