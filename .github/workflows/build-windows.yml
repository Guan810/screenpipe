name: Build Windows Release

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags: ["v*"]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~\.cargo\registry
            ~\.cargo\git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Bun
          key: bun-${{ runner.os }}-${{ hashFiles('screenpipe-app-tauri/bun.lockb') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Install Visual Studio BuildTools
        continue-on-error: true
        run: winget install -e --id Microsoft.VisualStudio.2022.BuildTools --override "--wait --quiet --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended" --accept-package-agreements --accept-source-agreements

      - name: Install Rust
        continue-on-error: true
        run: winget install -e --id Rustlang.Rustup --accept-package-agreements --accept-source-agreements

      - name: Install LLVM
        continue-on-error: true
        run: winget install -e --id LLVM.LLVM --accept-package-agreements --accept-source-agreements

      - name: Install CMake
        continue-on-error: true
        run: winget install -e --id Kitware.CMake --accept-package-agreements --accept-source-agreements

      - name: Install UnZip
        continue-on-error: true
        run: winget install -e --id GnuWin32.UnZip --accept-package-agreements --accept-source-agreements

      - name: Install Git
        continue-on-error: true
        run: winget install -e --id Git.Git --accept-package-agreements --accept-source-agreements

      - name: Install Wget
        continue-on-error: true
        run: winget install -e --id JernejSimoncic.Wget --accept-package-agreements --accept-source-agreements

      - name: Install 7zip
        continue-on-error: true
        run: winget install -e --id 7zip.7zip --accept-package-agreements --accept-source-agreements

      - name: Install Bun
        run: |
          irm https://bun.sh/install.ps1 | iex
          echo "$env:USERPROFILE\.bun\bin" >> $env:GITHUB_PATH

      - name: Set environment variables
        run: |
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files (x86)\GnuWin32\bin" >> $env:GITHUB_PATH

      - name: Setup Intel OpenMP DLLs
        run: |
          $mkl_dir = "${{ github.workspace }}\screenpipe-app-tauri\src-tauri\mkl"
          New-Item -ItemType Directory -Force -Path $mkl_dir | Out-Null
          python -m pip install --upgrade pip
          $temp_dir = "temp_omp"
          New-Item -ItemType Directory -Force -Path $temp_dir | Out-Null
          Write-Host "Installing Intel OpenMP..."
          python -m pip install intel-openmp --target $temp_dir
          Write-Host "Copying DLL files..."
          Get-ChildItem -Path $temp_dir -Recurse -Filter "*.dll" | ForEach-Object {
              Write-Host "Copying $_"
              Copy-Item $_.FullName -Destination $mkl_dir -Force
          }
          Remove-Item -Path $temp_dir -Recurse -Force

      - name: Setup vcredist
        run: |
          $path = "C:\Windows\System32\vcruntime140.dll"
          if (-Not (Test-Path $path)) {
              Write-Host "vcruntime140.dll not found, installing vcredist..."
              $url = 'https://aka.ms/vs/17/release/vc_redist.x64.exe'
              $installer = "$env:TEMP\vc_redist.x64.exe"
              Invoke-WebRequest -Uri $url -OutFile $installer
              Start-Process -FilePath $installer -Args '/install /quiet /norestart' -Wait
          }
          $vcredist_dir = "${{ github.workspace }}\screenpipe-app-tauri\src-tauri\vcredist"
          New-Item -ItemType Directory -Force -Path $vcredist_dir | Out-Null
          Copy-Item $path -Destination $vcredist_dir -Force
          Write-Host "vcruntime140.dll copied successfully!"

      - name: Build screenpipe
        run: cargo build --release

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ""
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        run: |
          cd screenpipe-app-tauri
          bun install
          bun tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: screenpipe-windows
          path: |
            screenpipe-app-tauri\src-tauri\target\release\bundle\msi\*.msi
            screenpipe-app-tauri\src-tauri\target\release\bundle\nsis\*.exe
