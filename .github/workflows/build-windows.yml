name: Build Windows Release

on:
  workflow_dispatch: # 手动触发
  push:
    tags:
      - "v*" # 推送 tag 时自动构建（如 v0.1.0）

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh # 全部使用 PowerShell Core（推荐）

    steps:
      # 1. Checkout 代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. 安装 winget（windows-latest 已经自带，但保险起见显式更新）
      - name: Update winget
        run: |
          winget upgrade --id Microsoft.Winget.Source_8wekyb3d8bbwe --accept-package-agreements --accept-source-agreements

      # 3. 安装所有必需工具（并行安装，节省时间）
      - name: Install required tools via winget
        run: |
          winget install -e --id Microsoft.VisualStudio.2022.BuildTools --override "--wait --quiet --add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.Windows10SDK.20348 --includeRecommended" --accept-package-agreements --accept-source-agreements
          winget install -e --id Rustlang.Rustup --accept-package-agreements --accept-source-agreements
          winget install -e --id LLVM.LLVM --accept-package-agreements --accept-source-agreements
          winget install -e --id Kitware.CMake --accept-package-agreements --accept-source-agreements
          winget install -e --id GnuWin32.UnZip --accept-package-agreements --accept-source-agreements
          winget install -e --id Git.Git --accept-package-agreements --accept-source-agreements
          winget install -e --id JernejSimoncic.Wget --accept-package-agreements --accept-source-agreements
          winget install -e --id 7zip.7zip --accept-package-agreements --accept-source-agreements

      # 4. 安装 Bun（官方 PowerShell 一行安装）
      - name: Install Bun
        run: iwr https://bun.sh/install.ps1 -useb | iex

      # 5. 设置 vcpkg（在 C:\vcpkg，避免路径太长）
      - name: Setup vcpkg
        run: |
          mkdir C:\vcpkg
          cd C:\vcpkg
          git clone https://github.com/microsoft/vcpkg.git .
          .\bootstrap-vcpkg.bat -disableMetrics
          .\vcpkg.exe integrate install --disable-metrics
          .\vcpkg.exe install ffmpeg:x64-windows --triplet x64-windows

      # 6. 设置持久化环境变量（对后续步骤有效）
      - name: Set environment variables
        run: |
          echo "VCPKG_ROOT=C:\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PKG_CONFIG_PATH=C:\vcpkg\installed\x64-windows\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "C:\Program Files (x86)\GnuWin32\bin" >> $env:GITHUB_PATH

      # 7. 安装 Intel OpenMP DLLs（复制到项目中）
      - name: Install Intel OpenMP DLLs
        run: |
          python -m pip install --upgrade pip
          $mkl_dir = Join-Path (Get-Location) "screenpipe-app-tauri\src-tauri\mkl"
          New-Item -ItemType Directory -Force -Path $mkl_dir | Out-Null

          $temp_dir = "temp_openmp"
          New-Item -ItemType Directory -Force -Path $temp_dir | Out-Null

          python -m pip install intel-openmp --target $temp_dir

          Get-ChildItem -Path $temp_dir -Recurse -Filter "*.dll" | ForEach-Object {
              Copy-Item $_.FullName -Destination $mkl_dir -Force
          }
          Remove-Item -Path $temp_dir -Recurse -Force

      # 8. 确保 VCRuntime 已安装并复制 vcruntime140.dll
      - name: Ensure VCRuntime and copy vcruntime140.dll
        run: |
          $dll = "C:\Windows\System32\vcruntime140.dll"
          if (-Not (Test-Path $dll)) {
              Write-Host "vcruntime140.dll not found, installing Visual C++ Redistributable..."
              Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "$env:TEMP\vc_redist.x64.exe"
              Start-Process -FilePath "$env:TEMP\vc_redist.x64.exe" -ArgumentList "/install /quiet /norestart" -Wait
          }

          $target = Join-Path (Get-Location) "screenpipe-app-tauri\src-tauri\vcredist"
          New-Item -ItemType Directory -Force -Path $target
          Copy-Item $dll -Destination $target -Force
          Write-Host "vcruntime140.dll copied!"

      # 9. 安装 Rust toolchain（默认安装 stable-x86_64-pc-windows-msvc）
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-msvc
          override: true
          components: rustfmt, clippy

      # 10. 缓存 cargo 依赖（大幅提速）
      - name: Cache cargo registry & build
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\cargo\registry
            ~\AppData\Local\cargo\git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # 11. 构建 screenpipe（Rust 部分）
      - name: Cargo build --release
        run: |
          cargo build --release --locked

      # 12. 构建 Tauri 前端 + 打包
      - name: Bun install & Tauri build
        run: |
          cd screenpipe-app-tauri
          bun install --frozen-lockfile
          bun tauri build

      # 13. 上传生成的安装包（通常在 src-tauri/target/release/bundle/ 下）
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: screenpipe-windows-installer
          path: |
            screenpipe-app-tauri/src-tauri/target/release/bundle/msi/*.msi
            screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error
