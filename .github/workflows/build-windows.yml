name: Build ScreenPipe for Windows

on:
  workflow_dispatch:

env:
  VCPKG_ROOT: "C:\\vcpkg"
  TAURI_DIR: "screenpipe-app-tauri"

jobs:
  # --- Job 1: 后端构建 (修复了 Sidecar 缺失问题) ---
  backend-build:
    name: Build Rust Backend
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 1. 缓存 vcpkg
      - name: Restore vcpkg Cache
        id: vcpkg-cache
        uses: actions/cache@v3
        with:
          path: C:\vcpkg\installed
          key: ${{ runner.os }}-vcpkg-ffmpeg-build-v2

      - name: Install FFmpeg via vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        run: |
          cd C:\vcpkg
          .\vcpkg.exe install ffmpeg:x64-windows
          .\vcpkg.exe integrate install

      - name: Set Environment Variables
        run: |
          echo "PKG_CONFIG_PATH=C:\vcpkg\installed\x64-windows\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      # 2. 修复 OpenMP
      - name: Setup Intel OpenMP DLLs
        run: |
          $mkl_dir = "${{ env.TAURI_DIR }}\src-tauri\mkl"
          if (-not (Test-Path $mkl_dir)) { New-Item -ItemType Directory -Force -Path $mkl_dir }
          $temp_dir = "temp_omp"
          pip install intel-openmp --target $temp_dir
          Get-ChildItem -Path $temp_dir -Recurse -Filter "*.dll" | ForEach-Object {
              Copy-Item $_.FullName -Destination $mkl_dir -Force
          }
          Remove-Item -Path $temp_dir -Recurse -Force

      # 3. 修复 VC Redist
      - name: Setup VC Redist
        run: |
          $vcredist_dir = "${{ env.TAURI_DIR }}\src-tauri\vcredist"
          if (-not (Test-Path $vcredist_dir)) { New-Item -ItemType Directory -Force -Path $vcredist_dir }
          $sys_path = "C:\Windows\System32\vcruntime140.dll"
          if (Test-Path $sys_path) { Copy-Item $sys_path -Destination $vcredist_dir -Force }

      # 4. === 关键修复：先编译核心引擎 (Sidecar) ===
      - name: Build Core Engine (Sidecar)
        run: |
          echo "Building screenpipe core binary..."
          # 在根目录编译 screenpipe 二进制文件
          # 注意：这里假设 cargo workspace 中有一个名为 screenpipe 的 binary
          cargo build --release --bin screenpipe
          
          echo "Preparing Sidecar..."
          # 定义源路径 (Rust 默认输出位置)
          $src_bin = "target\release\screenpipe.exe"
          
          # 定义目标路径 (Tauri 期待的 Sidecar 格式: name-target_triple.exe)
          # 通常 Tauri 在 src-tauri 根目录下寻找，或者 src-tauri/binaries
          # 根据报错 'resource path ... doesn't exist'，我们先尝试放到 src-tauri 根目录
          $target_triple = "x86_64-pc-windows-msvc"
          $dest_bin = "${{ env.TAURI_DIR }}\src-tauri\screenpipe-$target_triple.exe"
          
          if (Test-Path $src_bin) {
             Copy-Item $src_bin -Destination $dest_bin -Force
             Write-Host "Sidecar created successfully at: $dest_bin"
          } else {
             Write-Error "Failed to build screenpipe.exe. Check cargo build output."
             exit 1
          }

      # 5. 修复 Tauri 依赖版本 (防止后续报错)
      - name: Fix Tauri Dependency Mismatch
        run: |
          cd ${{ env.TAURI_DIR }}/src-tauri
          cargo update

      # 6. 编译 Tauri 后端 (现在 Sidecar 已存在，这一步应该能通过了)
      - name: Compile Tauri Backend
        run: |
          cd ${{ env.TAURI_DIR }}/src-tauri
          cargo build --release

      # 7. 上传产物 (传递给打包 Job)
      - name: Upload Backend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-binaries
          path: |
            ${{ env.TAURI_DIR }}/src-tauri/target/release/*.exe
            ${{ env.TAURI_DIR }}/src-tauri/target/release/*.dll
            ${{ env.TAURI_DIR }}/src-tauri/screenpipe-*.exe
            ${{ env.TAURI_DIR }}/src-tauri/mkl/*.dll
            ${{ env.TAURI_DIR }}/src-tauri/vcredist/*.dll

  # --- Job 2: 前端打包 (保持不变，依赖 Job 1) ---
  frontend-bundle:
    name: Bundle Frontend & Installer
    needs: backend-build
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # 下载所有编译好的二进制文件 (包括 Sidecar)
      - name: Download Backend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-binaries
          path: temp_artifacts

      - name: Restore Artifacts
        run: |
          # 还原目录结构
          New-Item -ItemType Directory -Force -Path "${{ env.TAURI_DIR }}\src-tauri\target\release"
          New-Item -ItemType Directory -Force -Path "${{ env.TAURI_DIR }}\src-tauri\mkl"
          New-Item -ItemType Directory -Force -Path "${{ env.TAURI_DIR }}\src-tauri\vcredist"
          
          # 1. 还原编译产物
          Copy-Item "temp_artifacts\*.dll" -Destination "${{ env.TAURI_DIR }}\src-tauri\target\release\" -Force
          Copy-Item "temp_artifacts\*.exe" -Destination "${{ env.TAURI_DIR }}\src-tauri\target\release\" -Force
          
          # 2. 关键：还原 Sidecar 到 src-tauri 根目录
          Copy-Item "temp_artifacts\screenpipe-*.exe" -Destination "${{ env.TAURI_DIR }}\src-tauri\" -Force
          
          # 3. 还原其他依赖
          Copy-Item "temp_artifacts\mkl\*" -Destination "${{ env.TAURI_DIR }}\src-tauri\mkl\" -Force
          Copy-Item "temp_artifacts\vcredist\*" -Destination "${{ env.TAURI_DIR }}\src-tauri\vcredist\" -Force

      - name: Ensure Cargo Versions Match
        run: |
          cd ${{ env.TAURI_DIR }}/src-tauri
          cargo update

      - name: Build Frontend & Bundle
        run: |
          cd ${{ env.TAURI_DIR }}
          bun install
          bun tauri build

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: ScreenPipe-Installer
          path: |
            ${{ env.TAURI_DIR }}/src-tauri/target/release/bundle/msi/*.msi
            ${{ env.TAURI_DIR }}/src-tauri/target/release/bundle/nsis/*.exe
