name: Build ScreenPipe for Windows

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: windows-latest
    
    env:
      VCPKG_ROOT: "C:\\vcpkg"
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Bun (Frontend Runtime)
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Rust (Backend Runtime)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Python (For OpenMP script)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # --- 缓存优化 ---
      - name: Restore vcpkg Cache
        id: vcpkg-cache
        uses: actions/cache@v3
        with:
          path: C:\vcpkg\installed
          key: ${{ runner.os }}-vcpkg-ffmpeg-build

      - name: Install FFmpeg via vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        run: |
          cd C:\vcpkg
          .\vcpkg.exe install ffmpeg:x64-windows
          .\vcpkg.exe integrate install

      - name: Set Environment Variables for Build
        run: |
          echo "PKG_CONFIG_PATH=C:\vcpkg\installed\x64-windows\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH

      # --- 修复后的第 6 步 ---
      - name: Setup Intel OpenMP DLLs (Fixed)
        run: |
          # 注意：这里不需要 cd screenpipe，我们已经在根目录了
          
          # 1. 定义目标目录 (相对路径)
          $mkl_dir = "screenpipe-app-tauri\src-tauri\mkl"
          if (-not (Test-Path $mkl_dir)) { New-Item -ItemType Directory -Force -Path $mkl_dir }

          # 2. 安装 intel-openmp 到临时目录
          $temp_dir = "temp_omp"
          if (-not (Test-Path $temp_dir)) { New-Item -ItemType Directory -Force -Path $temp_dir }
          
          pip install intel-openmp --target $temp_dir

          # 3. 复制 DLL 文件
          Write-Host "Copying DLL files..."
          Get-ChildItem -Path $temp_dir -Recurse -Filter "*.dll" | ForEach-Object {
              Write-Host "Copying $($_.Name)"
              Copy-Item $_.FullName -Destination $mkl_dir -Force
          }
          
          # 4. 清理
          Remove-Item -Path $temp_dir -Recurse -Force

      # --- 修复后的第 7 步 ---
      - name: Setup VC Redist (Fixed)
        run: |
          # 同样不需要 cd screenpipe
          
          $vcredist_dir = "screenpipe-app-tauri\src-tauri\vcredist"
          if (-not (Test-Path $vcredist_dir)) { New-Item -ItemType Directory -Force -Path $vcredist_dir }
          
          # 尝试直接从系统获取 vcruntime140.dll (GitHub Runner 通常自带)
          $sys_path = "C:\Windows\System32\vcruntime140.dll"
          
          if (Test-Path $sys_path) {
             Copy-Item $sys_path -Destination $vcredist_dir -Force
             Write-Host "vcruntime140.dll copied successfully."
          } else {
             Write-Warning "vcruntime140.dll not found in System32. Skipping copy, build might rely on static link or system path."
          }

      # --- 修复后的构建步骤 ---
      - name: Build Backend (Cargo)
        run: |
          # 不需要 cd screenpipe，直接在根目录构建
          cargo build --release

      - name: Build Frontend & Bundle (Tauri)
        run: |
          # 这里只需要进入子目录
          cd screenpipe-app-tauri
          bun install
          bun tauri build

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ScreenPipe-Installer
          path: |
            screenpipe-app-tauri/src-tauri/target/release/bundle/msi/*.msi
            screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe
